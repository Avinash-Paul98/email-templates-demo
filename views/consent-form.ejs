<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&amp;family=DM+Sans:wght@400;500;600;700&amp;family=Tiro+Bangla::wght@400;800&amp;family=Abhaya+Libre:wght@400;800&amp;display=swap"
      rel="stylesheet"
      type="text/css"
    />
    <title>Patient Consent Form</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: DM Sans, BlinkMacSystemFont, Segoe UI, Helvetica Neue,
          Arial, sans-serif !important;
        background-color: #f9f9f9;
        margin: 0;
        padding: 20px;
      }

      .form-container {
        max-width: 595px;
        margin: 0 auto;
        background-color: white;
        padding: 28px 20px 56px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      /* Download Button Styles */
      .download-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      .download-btn {
        background-color: #93763c;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .download-btn:hover {
        background-color: #7a6233;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .download-btn:active {
        transform: translateY(0);
      }

      /* Header Styles */
      .form-header {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: space-between;
        align-items: flex-end;
        width: 100%;
        margin-bottom: 36px;
      }

      .form-title {
        font-family: Tiro Bangla, serif !important;
        color: #93763c;
        font-size: 30px;
        font-weight: 400;
        line-height: 50.033px;
        font-variant: all-small-caps;
        margin-top: 36px;
      }

      .form-logo {
        max-width: 114px;
        width: 100%;
        aspect-ratio: 1.65;
        object-fit: contain;
      }

      /* Section Styles */
      .section {
        padding: 12px;
        margin-top: 12px;
        width: 100%;
        border-radius: 8px;
        background-color: #fafaf9;
      }

      .section-title {
        margin-bottom: 16px;
        color: #93763C;
        font-size: 12px;
        font-weight: 600;
        line-height: 22px;
      }

      .section-content {
        width: 100%;
      }

      /* Detail Row Styles */
      .detail-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        width: 100%;
        margin-bottom: 12px;
      }

      .detail-row.multiline {
        align-items: flex-start;
      }

      .detail-row:last-child {
        margin-bottom: 0;
      }

      .detail-label {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 240px;
        width: 280px;
        color: #9A9A9A;
        font-size: 12px;
        font-style: normal;
        font-weight: 400;
        line-height: 22px;
      }

      .detail-value {
        color: #444444;
        font-size: 12px;
        line-height: 1.5;
        flex: 1;
      }

      .detail-value.bold {
        font-weight: 600;
        color: #0f172a;
      }

      /* Question Row Styles */
      .question-row {
        width: 100%;
        padding-bottom: 12px;
        border-bottom: 1px dashed #e5e5e5;
        margin-bottom: 14px;
      }

      .question-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .question-content {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        width: 100%;
      }

      .question-label {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 240px;
        flex: 1;
        color: #0f172a;
        font-size: 12px;
        font-weight: 500;
        line-height: 1.25;
      }

      .question-answer {
        color: #0f172a;
        font-size: 12px;
        font-weight: 600;
        line-height: 1.5;
        white-space: nowrap;
      }

      .question-answer.flexible {
        white-space: normal;
      }

      /* Text Area Styles */
      .text-area {
        gap: 10px;
        padding: 14px 10px;
        margin-top: 10px;
        width: 100%;
        font-size: 12px;
        line-height: 1.75;
        background-color: white;
        border-radius: 6px;
        color: #52525b;
      }

      /* Payment Details Styles */
      .payment-header {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .payment-badge {
        gap: 10px;
        padding: 6px 10px;
        white-space: nowrap;
        border-radius: 4px;
        border: 1px solid #93763C;
        background-color: #fafaf9;
        color: #0f172a;
        min-height: 19px;
        color: #00152B;
        display: flex;
        align-items: center;
        height: 19px;
        font-size: 9px;
        font-style: normal;
        font-weight: 500;
        line-height: 22px;
        margin-bottom: 16px;
      }

      /* Consent Section Styles */
      .consent-text {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 16px;
        width: 100%;
        font-size: 12px;
        line-height: 1.33;
        text-align: justify;
        text-transform: capitalize;
        color: #262626;
      }

      .consent-paragraph {
        margin-bottom: 20px;
      }

      .consent-paragraph:last-child {
        margin-bottom: 0;
      }

      /* Signature Section Styles */
      .signature-section {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: center;
        padding: 12px;
        margin-top: 16px;
        width: 100%;
        font-size: 14px;
        font-weight: 500;
        line-height: 1;
        white-space: nowrap;
        border-radius: 8px;
        background-color: #fafaf9;
        color: #0f172a;
      }

      .signature-label {
        width: 63px;
      }

      .signature-box {
        height: 45px;
        width: 121px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background-color: white;
      }

      /* Final Details Styles */
      .final-detail-row {
        width: 100%;
        padding-bottom: 12px;
        border-bottom: 1px dashed #e5e5e5;
        margin-bottom: 14px;
      }

      .final-detail-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .final-detail-content {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-start;
        width: 100%;
      }

      .final-detail-content.center {
        align-items: center;
      }

      .final-detail-label {
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 12px;
        font-weight: 500;
        line-height: 1.25;
        min-width: 240px;
        width: 440px;
      }

      .final-detail-value {
        font-size: 12px;
        font-weight: 600;
        line-height: 1.5;
        color: #0f172a;
      }

      .final-detail-value.nowrap {
        white-space: nowrap;
      }

      .additional-question {
        margin-top: 14px;
        width: 100%;
        font-size: 12px;
        line-height: 1.75;
      }

      .additional-question-label {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        font-weight: 500;
        color: #0f172a;
        margin-bottom: 10px;
      }

      .additional-question-text {
        gap: 10px;
        padding: 14px 10px;
        background-color: white;
        border-radius: 6px;
        color: #52525b;
      }

      @media print {
        body {
          background-color: white;
          padding: 0;
        }
        
        .form-container {
          box-shadow: none;
          max-width: none;
        }

        .download-container {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <!-- Download Button -->
    <div class="download-container">
      <button class="download-btn" onclick="downloadPDF()">
        📄 Download PDF
      </button>
    </div>

    <div class="form-container" id="consent-form">
      <!-- Form Header -->
      <header class="form-header">
        <h1 class="form-title">Patient Consent Form</h1>
        <img src="leh-logo.png" 
             alt="Medical facility logo" class="form-logo" />
      </header>

      <div class="form-sections">
        <!-- Patient Details Section -->
        <section class="section">
          <h2 class="section-title">Patient Details</h2>
          <div class="section-content">
            <div class="detail-row">
              <div class="detail-label">Full Name</div>
              <div class="detail-value"><%= patient.fullName %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Date Of Birth</div>
              <div class="detail-value"><%= patient.dateOfBirth %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Gender</div>
              <div class="detail-value"><%= patient.gender %></div>
            </div>
            <div class="detail-row multiline">
              <div class="detail-label">London Address</div>
              <div class="detail-value"><%- patient.londonAddress.replace(/\n/g, '<br>') %></div>
            </div>
            <div class="detail-row multiline">
              <div class="detail-label">Overseas or Other UK Permanent Address<br>(if different from above)</div>
              <div class="detail-value"><%- patient.overseasAddress.replace(/\n/g, '<br>') %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Home Tel</div>
              <div class="detail-value"><%= patient.homeTel %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Work Tel</div>
              <div class="detail-value"><%= patient.workTel %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Mobile No</div>
              <div class="detail-value"><%= patient.mobileNo %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Email</div>
              <div class="detail-value"><%= patient.email %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Occupation</div>
              <div class="detail-value"><%= patient.occupation %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">How did you know about the practice?</div>
              <div class="detail-value"><%= patient.howDidYouKnow %></div>
            </div>
          </div>
        </section>

        <!-- Previous NHS Section -->
        <section class="section">
          <h2 class="section-title">Previous NHS</h2>
          <div class="section-content">
            <div class="detail-row">
              <div class="detail-label">Tel</div>
              <div class="detail-value"><%= patient.previousNHSTel %></div>
            </div>
            <div class="detail-row multiline">
              <div class="detail-label">Address</div>
              <div class="detail-value"><%- patient.previousNHSAddress.replace(/\n/g, '<br>') %></div>
            </div>
          </div>
        </section>

        <!-- Payment Details Section -->
        <section class="section">
          <div class="payment-header">
            <h2 class="section-title">Payment Details</h2>
            <div class="payment-badge">Insured</div>
          </div>
          <div class="section-content">
            <div class="detail-row">
              <div class="detail-label">Insurance Name</div>
              <div class="detail-value"><%= patient.insuranceName %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Membership Number</div>
              <div class="detail-value"><%= patient.membershipNumber %></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Pre-authorization/Claim No</div>
              <div class="detail-value"><%= patient.preAuthNumber %></div>
            </div>
          </div>
        </section>

        <!-- Past Medical History Section -->
        <section class="section">
          <h2 class="section-title">Past Medical History</h2>
          <div class="section-content">
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do you have any significant past medical history?</div>
                <div class="question-answer"><%= patient.medicalHistory.pastMedicalHistory %></div>
              </div>
              <% if (patient.medicalHistory.pastMedicalHistoryDetails) { %>
              <div class="text-area">
                <%= patient.medicalHistory.pastMedicalHistoryDetails %>
              </div>
              <% } %>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Have you had any operations or been admitted to hospital?</div>
                <div class="question-answer"><%= patient.medicalHistory.operations %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Are there any other clinicians involved in your care?</div>
                <div class="question-answer"><%= patient.medicalHistory.otherClinicians %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Have you had any recent investigations? (e.g. blood tests, scans)</div>
                <div class="question-answer"><%= patient.medicalHistory.recentInvestigations %></div>
              </div>
              <% if (patient.medicalHistory.recentInvestigationsDetails) { %>
              <div class="text-area">
                <%= patient.medicalHistory.recentInvestigationsDetails %>
              </div>
              <% } %>
            </div>
            <div class="additional-question">
              <div class="additional-question-label">
                Please let us know if you would like any other doctor/consultant notified of this and/or any future<br>
                <span style="line-height: 16px">consultations</span>
              </div>
              <div class="additional-question-text">
                I was diagnosed with hypertension in 2018 and underwent appendectomy in 2020. I also have a history of seasonal allergies.
              </div>
            </div>
          </div>
        </section>

        <!-- Life Style Section -->
        <section class="section">
          <h2 class="section-title">Life Style</h2>
          <div class="section-content">
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do you exercise?</div>
                <div class="question-answer"><%= patient.lifestyle.exercise %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Diet</div>
                <div class="question-answer flexible"><%= patient.lifestyle.diet %></div>
              </div>
              <% if (patient.lifestyle.dietDetails) { %>
              <div class="text-area">
                <%= patient.lifestyle.dietDetails %>
              </div>
              <% } %>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do You Smoke?</div>
                <div class="question-answer flexible"><%= patient.lifestyle.smoking %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do you drink alcohol?</div>
                <div class="question-answer"><%= patient.lifestyle.alcohol %></div>
              </div>
            </div>
          </div>
        </section>

        <!-- For Female Patients Section -->
        <section class="section">
          <h2 class="section-title">For Female Patients</h2>
          <div class="section-content">
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do you have any problems with your periods?</div>
                <div class="question-answer"><%= patient.femalePatients.periodProblems %></div>
              </div>
              <% if (patient.femalePatients.periodProblemsDetails) { %>
              <div class="text-area">
                <%= patient.femalePatients.periodProblemsDetails %>
              </div>
              <% } %>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Could you be pregnant?</div>
                <div class="question-answer"><%= patient.femalePatients.pregnant %></div>
              </div>
              <% if (patient.femalePatients.pregnantDetails) { %>
              <div class="text-area" style="line-height: 1.25;">
                <%= patient.femalePatients.pregnantDetails %>
              </div>
              <% } %>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Any breast problems, for example lumps?</div>
                <div class="question-answer"><%= patient.femalePatients.breastProblems %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Have you had a mammogram (inc. date)?</div>
                <div class="question-answer"><%= patient.femalePatients.mammogram %></div>
              </div>
            </div>
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Are you require / use contraception?</div>
                <div class="question-answer"><%= patient.femalePatients.contraception %></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Chaperone Section -->
        <section class="section">
          <div class="section-content">
            <div class="question-row">
              <div class="question-content">
                <div class="question-label">Do you require a chaperone for this consultation?</div>
                <div class="question-answer"><%= patient.chaperone %></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Consent Section -->
        <section class="section">
          <h2 class="section-title">
            A<span style="text-transform: lowercase;">GREEMENT, </span>
            <span style="text-transform: uppercase;">D</span>
            <span style="text-transform: lowercase;">ECLARATION </span>
            <span style="text-transform: capitalize;">A</span>
            <span style="text-transform: lowercase;">ND </span>
            <span style="text-transform: capitalize;">C</span>
            <span style="text-transform: lowercase;">ONSENT</span>
          </h2>
          <div class="consent-text">
            <p class="consent-paragraph">
              I confirm that I have read, understood, and accept the terms and conditions outlined above. I understand that I am personally responsible for any costs associated with my procedure if these costs are not covered by medical insurance, insurer or other third party such as a guarantor. I undertake to settle all personal expenses, cost of treatment at the time of my departure or upon request. I give permission to LEH or any other healthcare professional involved in my care, to access health information about me that is relevant to my treatment, which may be held by LEH, other health professionals or health organisations.
            </p>
            <p class="consent-paragraph">
              I also confirm that the information I have provided in this registration form is a true reflection of my current health and past medical history.
            </p>
          </div>
        </section>

        <!-- Signature Section -->
        <div class="signature-section">
          <label class="signature-label">Signature</label>
          <div class="signature-box"></div>
        </div>

        <!-- Final Details Section -->
        <section class="section">
          <div class="section-content">
            <div class="final-detail-row">
              <div class="final-detail-content center">
                <div class="final-detail-label">
                  <div>Name</div>
                </div>
                <div class="final-detail-value"><%= patient.signatureName %></div>
              </div>
            </div>
            <div class="final-detail-row">
              <div class="final-detail-content center">
                <div class="final-detail-label">
                  <div>Date</div>
                </div>
                <div class="final-detail-value nowrap"><%= patient.signatureDate %></div>
              </div>
            </div>
            <div class="final-detail-row">
              <div class="final-detail-content">
                <div class="final-detail-label">
                  <div>If you are not the patient, please state relationship to the patient</div>
                </div>
                <div class="final-detail-value"><%= patient.relationship %></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Include jsPDF and html2canvas from reliable CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fallback for html2canvas -->
    <script>
      // Fallback loading for html2canvas if the first CDN fails
      if (!window.html2canvas) {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
        script.onload = function() {
          console.log('html2canvas loaded from fallback CDN');
        };
        script.onerror = function() {
          console.error('Failed to load html2canvas from fallback CDN');
        };
        document.head.appendChild(script);
      }
    </script>

    <script>
      // Wait for libraries to load
      function checkLibrariesLoaded() {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const maxAttempts = 50; // 5 seconds max wait
          
          function check() {
            attempts++;
            if (window.jspdf && window.html2canvas) {
              resolve();
            } else if (attempts >= maxAttempts) {
              reject(new Error('Libraries failed to load'));
            } else {
              setTimeout(check, 100);
            }
          }
          check();
        });
      }

      async function downloadPDF() {
        try {
          // Show loading state
          const downloadBtn = document.querySelector('.download-btn');
          const originalText = downloadBtn.innerHTML;
          downloadBtn.innerHTML = '⏳ Generating PDF...';
          downloadBtn.disabled = true;

          // Hide the download button temporarily
          const downloadContainer = document.querySelector('.download-container');
          downloadContainer.style.display = 'none';

          // Check if libraries are loaded
          await checkLibrariesLoaded();

          // Create a new jsPDF instance
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');

          // Get the form container
          const element = document.getElementById('consent-form');
          
          // Use html2canvas to convert HTML to canvas
          const canvas = await window.html2canvas(element, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: element.scrollWidth,
            height: element.scrollHeight,
            logging: false,
            onclone: function(clonedDoc) {
              // Remove any problematic elements from the cloned document
              const downloadElements = clonedDoc.querySelectorAll('.download-container');
              downloadElements.forEach(el => el.remove());
            }
          });

          // Calculate dimensions
          const imgData = canvas.toDataURL('image/png');
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 295; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          // Add first page
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          // Add additional pages if needed
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          // Generate filename with current date
          const currentDate = new Date().toISOString().split('T')[0];
          const filename = `Patient_Consent_Form_${currentDate}.pdf`;

          // Download the PDF
          pdf.save(filename);

          // Show success message
          alert('PDF downloaded successfully!');

        } catch (error) {
          console.error('Error generating PDF:', error);
          let errorMessage = 'Error generating PDF. Please try again.';
          
          if (error.message.includes('Libraries failed to load')) {
            errorMessage = 'Required libraries failed to load. Please refresh the page and try again.';
          } else if (error.message.includes('html2canvas')) {
            errorMessage = 'Error capturing form content. Please refresh the page and try again.';
          }
          
          alert(errorMessage);
        } finally {
          // Show the download button again
          const downloadContainer = document.querySelector('.download-container');
          downloadContainer.style.display = 'block';
          
          // Reset button state
          const downloadBtn = document.querySelector('.download-btn');
          if (downloadBtn) {
            downloadBtn.innerHTML = '📄 Download PDF';
            downloadBtn.disabled = false;
          }
        }
      }
    </script>
  </body>
</html>